# R NHSD 3 Set schema for HES

p_load(duckdb, DBI, tictoc, data.table, arrow, dplyr, logger)

log_info('Create in-memory HES dataset')

# Set schema for dataset
new_schema <-
  schema(
    STUDY_ID = string(),
    ACPSTAR_1 = string(),
    ACPSTAR_2 = string(),
    ACPSTAR_3 = string(),
    ACPSTAR_4 = string(),
    ACPSTAR_5 = string(),
    ACPSTAR_6 = string(),
    ACPSTAR_7 = string(),
    ACPSTAR_8 = string(),
    ACPSTAR_9 = string(),
    ADMIAGE = int32(),
    ADMIDATE = date32(),
    ADMIMETH = int32(),
    ADMINCAT = int32(),
    ADMISORC = int32(),
    CCG_RESIDENCE = string(),
    CCG_RESPONSIBILITY = string(),
    CCG_TREATMENT = string(),
    CLASSPAT = int32(),
    DEPDAYS_1 = int32(),
    DEPDAYS_2 = int32(),
    DEPDAYS_3 = int32(),
    DEPDAYS_4 = int32(),
    DEPDAYS_5 = int32(),
    DEPDAYS_6 = int32(),
    DEPDAYS_7 = int32(),
    DEPDAYS_8 = int32(),
    DEPDAYS_9 = int32(),
    DIAG_01 = string(),
    DIAG_02 = string(),
    DIAG_03 = string(),
    DIAG_04 = string(),
    DIAG_05 = string(),
    DIAG_06 = string(),
    DIAG_07 = string(),
    DIAG_08 = string(),
    DIAG_09 = string(),
    DIAG_10 = string(),
    DIAG_11 = string(),
    DIAG_12 = string(),
    DIAG_13 = string(),
    DIAG_14 = string(),
    DIAG_15 = string(),
    DIAG_16 = string(),
    DIAG_17 = string(),
    DIAG_18 = string(),
    DIAG_19 = string(),
    DIAG_20 = string(),
    DIAG_COUNT = string(),
    DISDATE = date32(),
    DISDEST = int32(),
    DISMETH = string(),
    DOMPROC = string(),
    ELECDATE = date32(),
    ELECDUR = int32(),
    ELECDUR_CALC = int32(),
    EPIDUR = int32(),
    EPIEND = date32(),
    EPIKEY = int64(),
    EPIORDER = int32(),
    EPISTART = date32(),
    EPISTAT = int32(),
    EPITYPE = int32(),
    ETHNOS = string(),
    ETHNIC5 = string(),
    FIRSTREG = string(),
    FYEAR = int32(),
    HRGNHS = string(),
    HRGNHSVN = string(),
    IMD04 = string(),
    IMD04_DECILE = string(),
    IMD04RK = int32(),
    INTDAYS_1 = int32(),
    INTDAYS_2 = int32(),
    INTDAYS_3 = int32(),
    INTDAYS_4 = int32(),
    INTDAYS_5 = int32(),
    INTDAYS_6 = int32(),
    INTDAYS_7 = int32(),
    INTDAYS_8 = int32(),
    INTDAYS_9 = int32(),
    INTMANIG = int32(),
    LSOA01 = string(),
    LSOA11 = string(),
    MAINSPEF = string(),
    NUMACP = int32(),
    OPDATE_01 = date32(),
    OPDATE_02 = date32(),
    OPDATE_03 = date32(),
    OPDATE_04 = date32(),
    OPDATE_05 = date32(),
    OPDATE_06 = string(),
    OPDATE_07 = string(),
    OPDATE_08 = string(),
    OPDATE_09 = string(),
    OPDATE_10 = string(),
    OPDATE_11 = string(),
    OPDATE_12 = string(),
    OPDATE_13 = string(),
    OPDATE_14 = string(),
    OPDATE_15 = string(),
    OPDATE_16 = string(),
    OPDATE_17 = string(),
    OPDATE_18 = string(),
    OPDATE_19 = string(),
    OPDATE_20 = string(),
    OPDATE_21 = string(),
    OPDATE_22 = string(),
    OPDATE_23 = string(),
    OPDATE_24 = string(),
    OPERSTAT = string(),
    OPERTN_01 = string(),
    OPERTN_02 = string(),
    OPERTN_03 = string(),
    OPERTN_04 = string(),
    OPERTN_05 = string(),
    OPERTN_06 = string(),
    OPERTN_07 = string(),
    OPERTN_08 = string(),
    OPERTN_09 = string(),
    OPERTN_10 = string(),
    OPERTN_11 = string(),
    OPERTN_12 = string(),
    OPERTN_13 = string(),
    OPERTN_14 = string(),
    OPERTN_15 = string(),
    OPERTN_16 = string(),
    OPERTN_17 = string(),
    OPERTN_18 = string(),
    OPERTN_19 = string(),
    OPERTN_20 = string(),
    OPERTN_21 = string(),
    OPERTN_22 = string(),
    OPERTN_23 = string(),
    OPERTN_24 = string(),
    ORGSUP_1 = int32(),
    ORGSUP_2 = int32(),
    ORGSUP_3 = int32(),
    ORGSUP_4 = int32(),
    ORGSUP_5 = int32(),
    ORGSUP_6 = int32(),
    ORGSUP_7 = int32(),
    ORGSUP_8 = int32(),
    ORGSUP_9 = int32(),
    POSOPDUR = int32(),
    PREOPDUR = int32(),
    PROCODE3 = string(),
    PROCODET = string(),
    PROTYPE = string(),
    PROVSPNOPS = string(),
    PURCODE = string(),
    RESSTHA06 = string(),
    RURURB_IND = int32(),
    SEX = int32(),
    SPELBGIN = int32(),
    SPELDUR = int32(),
    SPELEND = string(),
    STARTAGE = int32(),
    STHATRET = string(),
    SUSCOREHRG = string(),
    SUSHRG = string(),
    SUSHRGVERS = double(),
    TRANSIT = int8(),
    TRETSPEF = string(),
    WAITDAYS = int32(),
    WAITLIST = bool(),
    ami = int8(),
    cva = int8(),
    chf = int8(),
    ctd = int8(),
    dem = int8(),
    dia = int8(),
    ldi = int8(),
    pud = int8(),
    pvd = int8(),
    pdi = int8(),
    can = int8(),
    dco = int8(),
    par = int8(),
    rdi = int8(),
    mcan = int8(),
    sld = int8(),
    hiv = int8(),
    anaem = int8(),
    arthr = int8(),
    atria = int8(),
    cereb = int8(),
    chron = int8(),
    diabe = int8(),
    dizzi = int8(),
    dyspn = int8(),
    falls = int8(),
    footp = int8(),
    fragi = int8(),
    heari = int8(),
    heafa = int8(),
    heava = int8(),
    house = int8(),
    hyper = int8(),
    hypot = int8(),
    ischa = int8(),
    memor = int8(),
    mobil = int8(),
    osteo = int8(),
    parki = int8(),
    pepti = int8(),
    perip = int8(),
    respi = int8(),
    skinu = int8(),
    sleep = int8(),
    socia = int8(),
    thyro = int8(),
    incon = int8(),
    uridi = int8(),
    visua = int8(),
    weigh = int8(),
    activ = int8(),
    rq1 = bool(),
    rq2 = bool(),
    rq3 = bool(),
    rq4 = bool(),
    rq5 = bool(),
    rq6 = bool(),
    rq7 = bool(),
    rq8 = bool(),
    rq9 = bool(),
    rq10 = bool(),
    rq11 = bool(),
    rq12 = bool(),
    rq13 = bool(),
    rq14 = bool(),
    rq = int8(),
    compacva = int8(),
    complrti = int8(),
    compmi = int8(),
    compdvt  = int8(),
    comppe = int8(),
    compaki  = int8(),
    computi  = int8(),
    compwound = int8(),
    compssi  = int8(),
    compppf  = int8(),
    comppros = int8(),
    compnvinj = int8(),
    compbloodtx = int8(),
    jr = string(),
    ADMIDATE_FILLED = date32(),
    EPI_VALID = bool(),
    #EPIDUR_CALC = duration(),
    EPI_BAD = bool(),
    row_id = uint64()
  )


# Open dataset
hes <-
  open_dataset(
    paste0(data_dir,"HES_new/"), schema = new_schema)

# Check
hes %>% head() %>% collect()
